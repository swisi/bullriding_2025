{% extends "base.html" %}
{% block content %}

  <h2>Teilnehmer</h2>
  {% set hide_vr = hide_prelim_rounds|default(false) %}
  {% set vr_hidden_class = ' hidden-vr' if hide_vr else '' %}
  <form method="POST" action="{{ url_for('main.update_times_bulk') }}" class="update-form" id="participantsForm">
    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
    <button type="button" onclick="resetSorting()" class="btn btn-primary">Sortierung zurücksetzen</button>
    {% if not hide_vr %}
    <button type="button" class="btn btn-outline-secondary ml-2" id="toggleVrButton">{{ 'Vorrunden ausblenden' if not hide_vr else 'Vorrunden einblenden' }}</button>
    {% endif %}
    <table class="table table-striped table-sm" id="participantsTable">
      <thead>
        <tr>
          <th>Aktiv</th>
          <th onclick="sortTable(1, true)">Nr.</th>
          <th onclick="sortTable(2)">Vorname</th>
          <th onclick="sortTable(3)">Name</th>
          <th class="col-time vr-column{{ vr_hidden_class }}">VR 1</th>
          <th class="col-qual vr-column{{ vr_hidden_class }}">Q</th>
          <th class="col-time vr-column{{ vr_hidden_class }}">VR 2</th>
          <th class="col-qual vr-column{{ vr_hidden_class }}">Q</th>
          <th class="col-time vr-column{{ vr_hidden_class }}">VR 3</th>
          <th class="col-qual vr-column{{ vr_hidden_class }}">Q</th>
          <th class="col-time vr-column{{ vr_hidden_class }}">Top VR</th>
          <th class="col-time">ZR 1</th>
          <th class="col-time">ZR 2</th>
          <th class="col-time">Top ZR</th>
          <th class="col-qual">Q</th>
          <th class="col-time">Final</th>
        </tr>
      </thead>
      <tbody>
        {% for participant in participants %}
          <tr class="{% if participant.active %}table-success{% endif %}">
            <td>
              <button type="submit" class="btn btn-secondary btn-sm"
                      formaction="{{ url_for('main.set_active', id=participant.id) }}" formmethod="post">
                <i class="fas fa-play-circle"></i>
              </button>
            </td>
            <td>{{ participant.start_nr }}</td>
            <td>{{ participant.first_name }}</td>
            <td>{{ participant.last_name }}</td>
            <td class="vr-column{{ vr_hidden_class }}">
              <input type="text" name="time1_{{ participant.id }}" value="{{ participant.time1 or '' }}" class="form-control form-control-sm" onkeydown="submitAndFocusNext(event, this)">
            </td>

            <td class="vr-column{{ vr_hidden_class }}">
              {% if participant.round1_qualified %}<i class="fas fa-check-circle text-success"></i>{% else %}<i class="far fa-circle"></i>{% endif %}
            </td>
            <td class="vr-column{{ vr_hidden_class }}">
              <input type="text" name="time2_{{ participant.id }}" value="{{ participant.time2 or '' }}" class="form-control form-control-sm" onkeydown="submitAndFocusNext(event, this)" {% if  participant.round1_qualified %}disabled{% endif %}>
            </td>

            <td class="vr-column{{ vr_hidden_class }}">
              {% if participant.round2_qualified %}<i class="fas fa-check-circle text-success"></i>{% else %}<i class="far fa-circle"></i>{% endif %}
            </td>
            <td class="vr-column{{ vr_hidden_class }}">
              <input type="text" name="time3_{{ participant.id }}" value="{{ participant.time3 or '' }}" class="form-control form-control-sm" onkeydown="submitAndFocusNext(event, this)" {% if participant.round2_qualified %}disabled{% endif %}>
            </td>

            <td class="vr-column{{ vr_hidden_class }}">{% if participant.round3_qualified %}<i class="fas fa-check-circle text-success"></i>{% else %}<i class="far fa-circle"></i>{% endif %}
            </td>
            <td class="vr-column{{ vr_hidden_class }}">{{ participant.toptime_Vorrunde }}</td>
            <td>
              <input type="text" name="time4_{{ participant.id }}" value="{{ participant.time4 or '' }}" class="form-control form-control-sm" onkeydown="submitAndFocusNext(event, this)" {% if (not participant.round3_qualified) and (not hide_vr) %}disabled{% endif %}>
            </td>
            <td>
              <input type="text" name="time5_{{ participant.id }}" value="{{ participant.time5 or '' }}" class="form-control form-control-sm" onkeydown="submitAndFocusNext(event, this)" {% if (not participant.round3_qualified) and (not hide_vr) %}disabled{% endif %}>
            </td>
            <td>{{ participant.toptime_Zwischenrunde }}</td>
            <td>{% if hide_vr or participant.zwischenrunde_qualified %}<i class="fas fa-check-circle text-success"></i>{% else %}<i class="far fa-circle"></i>{% endif %}
            </td>
            <td>
              <input type="text" name="time6_{{ participant.id }}" value="{{ participant.time6 or '' }}" class="form-control form-control-sm" onkeydown="submitAndFocusNext(event, this)" {% if (not participant.zwischenrunde_qualified) and (not hide_vr) %}disabled{% endif %}>
            </td>
          </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr>
          <td colspan="4"></td>
          <td colspan="1" class="vr-column{{ vr_hidden_class }}">
              <button type="submit" class="btn btn-primary btn-block"
                      formaction="{{ url_for('main.finish_round', round='VR1') }}" formmethod="post">Abschliessend VR1</button>
          </td>
          <td class="vr-column{{ vr_hidden_class }}"></td>
          <td colspan="1" class="vr-column{{ vr_hidden_class }}">
              <button type="submit" class="btn btn-primary btn-block"
                      formaction="{{ url_for('main.finish_round', round='VR2') }}" formmethod="post">Abschliessend VR2</button>
          </td>
          <td class="vr-column{{ vr_hidden_class }}"></td>

          <td colspan="1" class="vr-column{{ vr_hidden_class }}">
              <button type="submit" class="btn btn-primary btn-block"
                      formaction="{{ url_for('main.finish_round', round='VR3') }}" formmethod="post">Abschliessend VR3</button>
          </td>
          <td class="vr-column{{ vr_hidden_class }}"></td>
          <td class="vr-column{{ vr_hidden_class }}"></td>
          <td colspan="2">
              <button type="submit" class="btn btn-primary btn-block"
                      formaction="{{ url_for('main.finish_round', round='ZR') }}" formmethod="post">Abschliessend ZR</button>
          </td>
          <td></td>
          <td></td>

          <td colspan="3">
              <button type="submit" class="btn btn-primary btn-block"
                      formaction="{{ url_for('main.finish_round', round='FINAL') }}" formmethod="post">Abschliessend FINAL</button>
          </td>
          <td></td>
        </tr>
      </tfoot>
    </table>
    <button type="button" onclick="resetSorting()" class="btn btn-primary">Sortierung zurücksetzen</button>
  </form>

  <style>
    .col-time {
      width: 100px;
    }
    .col-qual {
      width: 50px;
    }
    .hidden-vr {
      display: none !important;
    }
  </style>

  <script>
    // Function to submit and focus the next field in the column
    function submitAndFocusNext(event, currentField) {
      if (event.key === 'Enter') {
        event.preventDefault();

        let form = currentField.closest("form");
        let inputs = Array.from(document.querySelectorAll('input[type="text"]'));
        let currentIndex = inputs.indexOf(currentField);

        // Get the current field position
        let currentColumnIndex = Array.from(currentField.closest('tr').children).indexOf(currentField.closest('td'));
        let nextRowField = null;

        // Find the next field in the same column
        for (let i = currentIndex + 1; i < inputs.length; i++) {
          let field = inputs[i];
          let fieldColumnIndex = Array.from(field.closest('tr').children).indexOf(field.closest('td'));
          if (fieldColumnIndex === currentColumnIndex) {
            nextRowField = field;
            break;
          }
        }

        // Append hidden input to identify this submit action
        let hiddenInput = document.createElement('input');
        hiddenInput.type = 'hidden';
        hiddenInput.name = 'update_times';
        hiddenInput.value = 'true';
        form.appendChild(hiddenInput);

        // Submit the form
        let formData = new FormData(form);
        fetch(form.action, {
          method: "POST",
          body: formData,
        }).then(response => {
          if (response.ok) {
            if (nextRowField) {
              nextRowField.focus();
            }
          } else {
            console.error('Form submission failed');
          }
        }).catch(error => {
          console.error('Form submission error:', error);
        });
      }
    }

    // Function to sort the table
    function sortTable(n, isNumeric = false) {
      const table = document.getElementById("participantsTable");
      let rows, switching, i, x, y, shouldSwitch, dir, switchcount = 0;
      switching = true;
      dir = "asc"; 
      while (switching) {
        switching = false;
        rows = table.rows;
        for (i = 1; i < (rows.length - 1); i++) {
          shouldSwitch = false;
          x = rows[i].getElementsByTagName("TD")[n];
          y = rows[i + 1].getElementsByTagName("TD")[n];
          let xValue = isNumeric ? parseInt(x.innerHTML) : x.innerHTML.toLowerCase();
          let yValue = isNumeric ? parseInt(y.innerHTML) : y.innerHTML.toLowerCase();
          if (dir == "asc") {
            if (xValue > yValue) {
              shouldSwitch = true;
              break;
            }
          } else if (dir == "desc") {
            if (xValue < yValue) {
              shouldSwitch = true;
              break;
            }
          }
        }
        if (shouldSwitch) {
          rows[i].parentNode.insertBefore(rows[i + 1], rows[i]);
          switching = true;
          switchcount++; 
        } else {
          if (switchcount == 0 && dir == "asc") {
            dir = "desc";
            switching = true;
          }
        }
      }
    }

    // Function to reset the sorting
    function resetSorting() {
      window.location.reload();
    }

    document.addEventListener('DOMContentLoaded', function() {
      const toggleButton = document.getElementById('toggleVrButton');
      if (!toggleButton) {
        return;
      }

      const vrCells = document.querySelectorAll('.vr-column');
      let vrVisible = {{ (not hide_vr)|tojson }};

      function updateVrVisibility() {
        vrCells.forEach(cell => cell.classList.toggle('hidden-vr', !vrVisible));
        toggleButton.textContent = vrVisible ? 'Vorrunden ausblenden' : 'Vorrunden einblenden';
      }

      updateVrVisibility();

      toggleButton.addEventListener('click', function() {
        vrVisible = !vrVisible;
        updateVrVisibility();
      });
    });
  </script>

{% endblock %}
