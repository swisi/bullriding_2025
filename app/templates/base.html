<!doctype html>
<html lang="en" class="{% if theme == 'dark' %}theme-dark{% endif %}">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta name="color-scheme" content="dark light">
    <script>
      // Set theme class ASAP (before CSS loads) to avoid white flash
      (function() {
        try {
          var serverTheme = '{{ theme or '' }}';
          var theme = serverTheme || localStorage.getItem('theme');
          if (theme === 'dark') {
            document.documentElement.classList.add('theme-dark');
          }
        } catch (e) { /* ignore */ }
      })();
    </script>
    <style>
      /* Critical minimal dark styles to prevent white flash before CSS loads */
      html.theme-dark, html.theme-dark body { background-color: #121212; color: #e0e0e0; }
      html.theme-dark .navbar { background-color: #1e1e1e !important; }
      html.theme-dark .navbar .navbar-brand, 
      html.theme-dark .navbar .nav-link { color: rgba(255,255,255,.85) !important; }
    </style>
    <title>{{ title }} - {{ site_name }}</title>
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
    <link id="theme-css" rel="stylesheet" href="">
    <script>
      // Apply theme ASAP to reduce flash of incorrect theme
      (function() {
        try {
          var serverTheme = '{{ theme or '' }}';
          var theme = serverTheme || localStorage.getItem('theme') || 'light';
          var link = document.createElement('link');
          link.id = 'theme-css';
          link.rel = 'stylesheet';
          if (theme === 'dark') {
            link.href = '{{ url_for('static', filename='css/dark.css') }}';
          }
          // If element already exists (SSR), replace it
          var existing = document.getElementById('theme-css');
          if (existing) { existing.parentNode.replaceChild(link, existing); }
          else { document.head.appendChild(link); }
        } catch(e) { /* ignore */ }
      })();
    </script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet">
  </head>
  <body>
    <nav id="main-navbar" class="navbar navbar-expand-md navbar-light bg-light py-1">
      <div class="container">
        <a class="navbar-brand" href="{{ url_for('main.index') }}">{{ site_name }}</a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarCollapse">
          <ul class="navbar-nav mr-auto">
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('main.index') }}">Home</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('main.ranking') }}">Rangliste</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('main.active') }}">Live</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="{{ url_for('main.stage') }}">Stage</a>
          </li>
          {% if current_user.is_authenticated %}
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.participant') }}">Teilnehmer Liste</a>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.participant_add') }}">Teilnehmer erfassen</a>
            </li>
          {% endif %}
          </ul>
          <ul class="navbar-nav ml-auto">
          {% if current_user.is_authenticated %}
            <li class="nav-item dropdown">
              <a class="nav-link dropdown-toggle" href="#" id="adminMenu" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                Admin
              </a>
              <div class="dropdown-menu" aria-labelledby="adminMenu">
                <form method="POST" action="{{ url_for('main.reset_results') }}" class="px-3 py-1">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="dropdown-item">Resultate löschen</button>
                </form>
                <form method="POST" action="{{ url_for('main.reset_participants') }}" class="px-3 py-1">
                  <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                  <button type="submit" class="dropdown-item">Teilnehmer löschen</button>
                </form>
              </div>
            </li>
            <li class="nav-item">
              <button id="theme-toggle" type="button" class="btn btn-sm btn-outline-secondary ml-2">Dark</button>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.logout') }}">Logout</a>
            </li>
          {% else %}
            <li class="nav-item">
              <button id="theme-toggle" type="button" class="btn btn-sm btn-outline-secondary mr-2">Dark</button>
            </li>
            <li class="nav-item">
              <a class="nav-link" href="{{ url_for('main.login') }}">Login</a>
            </li>
          {% endif %}
          </ul>
        </div>
      </div>
    </nav>
    <div class="container">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }}" role="alert">
              {{ message }}
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </div>
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <style>
      .navbar .nav-link { padding: .25rem .5rem; }
      .navbar-brand { font-size: 1rem; }
    </style>
    <script>
      (function() {
        function applyTheme(theme) {
          var link = document.getElementById('theme-css');
          var navbar = document.getElementById('main-navbar');
          var toggle = document.getElementById('theme-toggle');
          if (!link || !navbar || !toggle) return;
          if (theme === 'dark') {
            link.href = '{{ url_for('static', filename='css/dark.css') }}';
            navbar.classList.remove('navbar-light', 'bg-light');
            navbar.classList.add('navbar-dark', 'bg-dark');
            toggle.textContent = 'Light';
          } else {
            link.href = '';
            navbar.classList.remove('navbar-dark', 'bg-dark');
            navbar.classList.add('navbar-light', 'bg-light');
            toggle.textContent = 'Dark';
          }
        }
        document.addEventListener('DOMContentLoaded', function() {
          var theme = '{{ theme or '' }}' || localStorage.getItem('theme') || 'light';
          applyTheme(theme);
          var toggle = document.getElementById('theme-toggle');
          if (toggle) {
            toggle.addEventListener('click', function() {
              var current = localStorage.getItem('theme') || '{{ theme or 'light' }}' || 'light';
              theme = current === 'dark' ? 'light' : 'dark';
              localStorage.setItem('theme', theme);
              // Persist to cookie for server-side rendering on next request
              var oneYear = 60 * 60 * 24 * 365;
              document.cookie = 'theme=' + theme + '; Max-Age=' + oneYear + '; Path=/; SameSite=Lax';
              applyTheme(theme);
            });
          }
        });
      })();
    </script>
  </body>
  </html>
